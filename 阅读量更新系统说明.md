# 微信公众号文章阅读量更新系统

## 功能概述

本系统用于定时获取微信公众号普法文章的阅读量、点赞量和在看量数据，通过调用第三方 API 接口实现数据的自动更新。

## 主要特性

- 🕒 **定时任务**: 每天早上 6 点自动执行（可自定义时间）
- 📊 **智能筛选**: 自动识别近 7 天内需要更新的普法文章
- 🔄 **批量处理**: 支持批量获取和更新文章数据
- 🛡️ **错误处理**: 完善的重试机制和错误处理
- 📈 **统计报告**: 提供详细的执行统计和进度报告
- ⚙️ **灵活配置**: 支持多种运行模式和参数配置

## 系统要求

- Python 3.9+
- MySQL 8.0+
- 第三方 API 服务账号（用于获取文章数据）

## 快速开始

### 1. 安装依赖

```bash
pip install schedule
```

或运行现有的安装脚本：

```bash
install.bat
```

### 2. 配置 API 密钥

编辑 `reading_updater_config.json` 文件：

```json
{
	"api": {
		"key": "your_actual_api_key_here",
		"verify_code": "",
		"base_url": "https://www.dajiala.com"
	}
}
```

### 3. 运行系统

#### 方式一：使用批处理文件（推荐）

双击运行 `阅读量更新.bat`，选择对应的功能。

#### 方式二：使用命令行

```bash
# 立即执行更新任务
python start_reading_updater.py --now

# 启动定时调度器（每天6:00执行）
python start_reading_updater.py --schedule

# 启动定时调度器（自定义时间，如每天8:30）
python start_reading_updater.py --schedule --hour 8 --minute 30

# 显示统计信息
python start_reading_updater.py --stats

# 试运行模式（只查询不更新）
python start_reading_updater.py --dry-run
```

## 配置说明

### reading_updater_config.json

```json
{
	"database": {
		"host": "127.0.0.1", // 数据库主机
		"port": 3306, // 数据库端口
		"user": "root", // 数据库用户名
		"password": "123456", // 数据库密码
		"database": "faxuan" // 数据库名称
	},
	"api": {
		"key": "your_api_key_here", // API密钥（必须配置）
		"verify_code": "", // 附加码（可选）
		"base_url": "https://www.dajiala.com" // API基础URL
	},
	"days_to_check": 7, // 检查近几天的文章
	"batch_size": 50, // 批处理大小
	"max_retries": 3, // 最大重试次数
	"enabled": true, // 是否启用任务
	"schedule": {
		"hour": 6, // 定时执行小时
		"minute": 0 // 定时执行分钟
	}
}
```

## 工作原理

### 1. 文章筛选逻辑

系统会查询满足以下条件的文章：

- 是普法文章（`fx_education_articles.type_class = '1'`）
- 发布时间在近 7 天内
- 阅读量、点赞量或在看量数据为空
- 有有效的文章 URL

### 2. 数据更新流程

1. **连接数据库**: 建立 MySQL 数据库连接
2. **查询文章**: 根据条件查询需要更新的文章列表
3. **调用 API**: 逐个调用第三方 API 获取文章数据
4. **更新数据**: 将获取的数据更新到数据库
5. **生成报告**: 输出统计信息和执行结果

### 3. 错误处理机制

- **QPS 限制**: 自动控制请求频率，不超过 5 次/秒
- **重试机制**: 失败请求自动重试，最多重试 3 次
- **错误分类**: 区分不同类型的错误并采取相应处理策略
- **日志记录**: 详细记录所有操作和错误信息

## API 接口说明

### 第三方 API

**接口地址**: `https://www.dajiala.com/fbmain/monitor/v3/read_zan`

**请求方法**: POST

**请求参数**:

```json
{
	"url": "微信文章链接",
	"key": "API密钥",
	"verifycode": "附加码（可选）"
}
```

**响应数据**:

```json
{
	"code": 0,
	"msg": "success",
	"data": {
		"read": 100001, // 阅读量
		"zan": 1988, // 点赞量
		"looking": 612 // 在看量
	},
	"cost_money": 0.02,
	"remain_money": 999999.372
}
```

### 错误码说明

| 错误码  | 说明               |
| ------- | ------------------ |
| 0       | 成功               |
| -1      | QPS 超过上限       |
| 101     | 文章被删除或违规   |
| 105/106 | 文章解析失败       |
| 107     | 解析失败，请重试   |
| 10002   | key 或附加码不正确 |
| 20001   | 金额不足           |
| 20002   | 微信链接格式错误   |
| 20003   | 文章链接有误       |
| 50000   | 内部服务器错误     |

## 数据库表结构

### fx_article_records（文章记录表）

主要字段：

- `view_count`: 阅读量
- `likes`: 点赞量
- `thumbs_count`: 在看量
- `article_url`: 文章链接
- `article_id`: 文章 ID

### fx_education_articles（普法教育文章表）

主要字段：

- `type_class`: 文章类型（'1'为普法文章）
- `article_id`: 关联文章 ID

## 日志和监控

### 日志文件位置

- 主程序日志: `logs/wechat_crawler.log`
- 更新任务日志: `logs/reading_updater.log`

### 监控指标

- 处理文章总数
- 成功更新数量
- 失败更新数量
- API 调用成功率
- 任务执行时长

## 常见问题

### Q: API 密钥如何获取？

A: 需要在第三方服务商（大家拉）官网注册并购买服务，获取 API 密钥。

### Q: 为什么有些文章获取失败？

A: 可能的原因：

- 文章被删除或违规
- 文章链接格式错误
- 网络连接问题
- API 服务暂时不可用

### Q: 如何调整执行时间？

A: 修改配置文件中的`schedule`部分，或使用命令行参数指定时间。

### Q: 如何查看执行结果？

A: 查看日志文件或使用`--stats`参数显示统计信息。

## 注意事项

1. **API 费用**: 每次调用 API 会产生费用（约 0.04 元/次），请注意余额
2. **QPS 限制**: API 有频率限制（5 次/秒），系统已自动处理
3. **数据备份**: 建议定期备份数据库数据
4. **配置安全**: API 密钥等敏感信息请妥善保管

## 维护和更新

### 定期维护任务

- 检查 API 余额是否充足
- 清理过期的日志文件
- 监控系统运行状态
- 更新配置参数

### 版本更新

- 查看更新日志
- 备份配置文件
- 更新代码文件
- 重启定时任务

## 技术支持

如有问题或建议，请联系系统管理员或查看项目文档。
